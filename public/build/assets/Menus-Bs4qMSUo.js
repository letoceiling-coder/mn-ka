import{_ as R,h as f,c as i,F as j,k as S,p as _,r as q,o as u,x as A,b as t,d as h,t as k,a as P,l as M,v as T,D as L,q as H,i as z,j as J}from"./app-BSkE_Ewe.js";import{a as F,c as N,b as G,d as K}from"./api-V9GPpd21.js";import{S as C}from"./sweetalert2.esm.all-C0u8rGqG.js";const Q={name:"MenuTree",props:{items:{type:Array,required:!0}},emits:["edit","delete","refresh","order-updated"],setup(g,{emit:r}){const c=f(null),e=f(null),m=f(null);return{draggedItem:c,draggedIndex:e,dragOverIndex:m,onDragStart:(s,p,x)=>{c.value=p,e.value=x,s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/html",s.target),s.target.style.opacity="0.5"},onDragEnd:s=>{s.target.style.opacity="1",c.value=null,e.value=null,m.value=null},onDragOver:s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},onItemDragOver:(s,p)=>{s.preventDefault(),e.value!==null&&e.value!==p&&(m.value=p)},onItemDragEnter:s=>{e.value!==null&&e.value!==s&&(m.value=s)},onItemDragLeave:()=>{},onDrop:s=>{if(s.preventDefault(),!c.value||e.value===null)return;const p=m.value!==null?m.value:e.value;if(e.value===p){m.value=null;return}const x=[...g.items],[B]=x.splice(e.value,1);x.splice(p,0,B);const U=x.map((y,n)=>({id:y.id,order:n,parent_id:y.parent_id||null}));r("order-updated",{items:U,newOrder:x.map(y=>y.id),newItems:x.map((y,n)=>({...y,order:n}))}),m.value=null}}}},W=["onDragstart","onDragover","onDragenter"],X={class:"flex items-center justify-between p-4 border-b border-border hover:bg-muted/5 cursor-move"},Y={class:"flex items-center gap-3 flex-1"},Z={class:"flex items-center gap-2 flex-1"},$={class:"text-sm font-medium text-foreground"},ee={class:"text-xs px-2 py-1 rounded bg-muted text-muted-foreground"},re={key:0,class:"text-xs text-muted-foreground"},te={key:1,class:"text-xs px-2 py-1 rounded bg-red-500/10 text-red-500"},oe={class:"flex items-center gap-2"},ne=["onClick"],le=["onClick"],ae={key:0,class:"ml-6 border-l border-border"};function se(g,r,c,e,m,E){const D=q("MenuTree",!0);return u(),i("div",{class:"menu-tree",onDragover:r[6]||(r[6]=_((...o)=>e.onDragOver&&e.onDragOver(...o),["prevent"])),onDrop:r[7]||(r[7]=_((...o)=>e.onDrop&&e.onDrop(...o),["prevent"]))},[(u(!0),i(j,null,S(c.items,(o,l)=>(u(),i("div",{key:o.id,class:A(["menu-item",{dragging:e.draggedItem?.id===o.id,"drag-over":e.dragOverIndex===l}]),draggable:!0,onDragstart:a=>e.onDragStart(a,o,l),onDragend:r[4]||(r[4]=(...a)=>e.onDragEnd&&e.onDragEnd(...a)),onDragover:_(a=>e.onItemDragOver(a,l),["prevent"]),onDragenter:_(a=>e.onItemDragEnter(l),["prevent"]),onDragleave:r[5]||(r[5]=(...a)=>e.onItemDragLeave&&e.onItemDragLeave(...a))},[t("div",X,[t("div",Y,[r[8]||(r[8]=t("svg",{class:"w-5 h-5 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 8h16M4 16h16"})],-1)),t("div",Z,[t("span",$,k(o.title),1),t("span",ee,k(o.type),1),o.url||o.slug?(u(),i("span",re,k(o.url||(o.slug?"/"+o.slug:"")),1)):h("",!0),o.is_active?h("",!0):(u(),i("span",te," Неактивен "))])]),t("div",oe,[t("button",{onClick:_(a=>g.$emit("edit",o),["stop"]),class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"}," Редактировать ",8,ne),t("button",{onClick:_(a=>g.$emit("delete",o),["stop"]),class:"px-3 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors"}," Удалить ",8,le)])]),o.children&&o.children.length>0?(u(),i("div",ae,[P(D,{items:o.children,onEdit:r[0]||(r[0]=a=>g.$emit("edit",a)),onDelete:r[1]||(r[1]=a=>g.$emit("delete",a)),onRefresh:r[2]||(r[2]=a=>g.$emit("refresh")),onOrderUpdated:r[3]||(r[3]=a=>g.$emit("order-updated",a))},null,8,["items"])])):h("",!0)],42,W))),128))],32)}const de=R(Q,[["render",se],["__scopeId","data-v-20f8c6fd"]]),ie={name:"Menus",components:{MenuTree:de},setup(){const g=f(!1),r=f(!1),c=f(null),e=f([]),m=f([]),E=f("header"),D=f(!1),o=f(!1),l=f({id:null,title:"",slug:"",url:"",type:"header",parent_id:null,order:0,is_active:!0}),a=[{value:"header",label:"Header Меню"},{value:"footer",label:"Footer Меню"},{value:"burger",label:"Burger Меню"}],V=z(()=>m.value.filter(n=>n.type===l.value.type&&n.id!==l.value.id&&(!n.parent_id||n.parent_id===null))),I=async()=>{g.value=!0,c.value=null;try{const n=await F("/menus",{type:E.value});if(!n.ok)throw new Error("Ошибка загрузки меню");const b=await n.json();e.value=b.data||[];const d=await F("/menus");if(d.ok){const v=await d.json();m.value=s(v.data||[])}}catch(n){c.value=n.message||"Ошибка загрузки меню"}finally{g.value=!1}},s=n=>{let b=[];return n.forEach(d=>{b.push(d),d.children&&d.children.length>0&&(b=b.concat(s(d.children)))}),b},p=n=>{l.value={id:n.id,title:n.title,slug:n.slug||"",url:n.url||"",type:n.type,parent_id:n.parent_id,order:n.order,is_active:n.is_active},o.value=!0},x=async n=>{if((await C.fire({title:"Удалить пункт меню?",text:`Вы уверены, что хотите удалить "${n.title}"?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Да, удалить",cancelButtonText:"Отмена"})).isConfirmed)try{const d=await K(`/menus/${n.id}`);if(!d.ok){const v=await d.json();throw new Error(v.message||"Ошибка удаления")}await C.fire("Удалено!","Пункт меню успешно удален.","success"),await I()}catch(d){await C.fire("Ошибка!",d.message||"Не удалось удалить пункт меню.","error")}},B=async()=>{r.value=!0,c.value=null;try{const n=l.value.id?`/menus/${l.value.id}`:"/menus",d=await(l.value.id?G:N)(n,{title:l.value.title,slug:l.value.slug||null,url:l.value.url||null,type:l.value.type,parent_id:l.value.parent_id||null,order:l.value.order||0,is_active:l.value.is_active});if(!d.ok){const v=await d.json();throw new Error(v.message||"Ошибка сохранения")}await C.fire("Успешно!","Пункт меню успешно сохранен.","success"),y(),await I()}catch(n){c.value=n.message||"Ошибка сохранения",await C.fire("Ошибка!",c.value,"error")}finally{r.value=!1}},U=n=>{const b=JSON.parse(JSON.stringify(e.value));if(n.newOrder&&Array.isArray(n.newOrder)){const v=new Map;e.value.forEach(w=>{v.set(w.id,{...w})}),e.value=n.newOrder.map(w=>{const O=v.get(w);return O?{...O}:null}).filter(Boolean),e.value.forEach((w,O)=>{w.order=O})}const d=n.items||[];N("/menus/update-order",{items:d}).then(v=>{if(!v.ok)return v.json().then(w=>{throw new Error(w.message||"Ошибка обновления порядка")})}).catch(v=>{console.error("Ошибка обновления порядка на сервере:",v),e.value=b,C.fire({title:"Ошибка",text:v.message||"Не удалось сохранить порядок меню. Изменения отменены.",icon:"error",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3})})},y=()=>{D.value=!1,o.value=!1,l.value={id:null,title:"",slug:"",url:"",type:E.value,parent_id:null,order:0,is_active:!0}};return J(async()=>{await I()}),{loading:g,saving:r,error:c,menus:e,selectedType:E,menuTypes:a,showCreateModal:D,showEditModal:o,form:l,availableParents:V,fetchMenus:I,editMenu:p,deleteMenu:x,saveMenu:B,closeModal:y,handleOrderUpdate:U}}},ue={class:"menus-page space-y-6"},ce={class:"flex items-center justify-between"},ve={class:"flex gap-2"},ge=["onClick"],me={key:0,class:"flex items-center justify-center py-12"},fe={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},be={class:"text-destructive"},pe={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},xe={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},ye={key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm overflow-y-auto p-4"},we={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md my-auto"},he={class:"p-6"},ke={class:"text-lg font-semibold mb-4"},De=["value"],Me={class:"flex items-center gap-2"},_e={class:"flex gap-2 pt-4"},Ee=["disabled"];function Ce(g,r,c,e,m,E){const D=q("MenuTree");return u(),i("div",ue,[t("div",ce,[r[11]||(r[11]=t("div",null,[t("h1",{class:"text-3xl font-semibold text-foreground"},"Меню"),t("p",{class:"text-muted-foreground mt-1"},"Управление меню сайта (Header, Footer, Burger)")],-1)),t("button",{onClick:r[0]||(r[0]=o=>e.showCreateModal=!0),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...r[10]||(r[10]=[t("span",null,"+",-1),t("span",null,"Создать пункт меню",-1)])])]),t("div",ve,[(u(!0),i(j,null,S(e.menuTypes,o=>(u(),i("button",{key:o.value,onClick:l=>{e.selectedType=o.value,e.fetchMenus()},class:A(["px-4 py-2 rounded-lg transition-colors",e.selectedType===o.value?"bg-accent/20 text-accent border border-accent/40":"bg-card border border-border text-foreground hover:bg-muted/10"])},k(o.label),11,ge))),128))]),e.loading?(u(),i("div",me,[...r[12]||(r[12]=[t("p",{class:"text-muted-foreground"},"Загрузка меню...",-1)])])):h("",!0),e.error?(u(),i("div",fe,[t("p",be,k(e.error),1)])):h("",!0),!e.loading&&e.menus.length>0?(u(),i("div",pe,[P(D,{items:e.menus,onEdit:e.editMenu,onDelete:e.deleteMenu,onRefresh:e.fetchMenus,onOrderUpdated:e.handleOrderUpdate},null,8,["items","onEdit","onDelete","onRefresh","onOrderUpdated"])])):h("",!0),!e.loading&&e.menus.length===0?(u(),i("div",xe,[...r[13]||(r[13]=[t("p",{class:"text-muted-foreground"},"Меню не найдены. Создайте первый пункт меню.",-1)])])):h("",!0),e.showCreateModal||e.showEditModal?(u(),i("div",ye,[t("div",we,[t("div",he,[t("h3",ke,k(e.showEditModal?"Редактировать пункт меню":"Создать пункт меню"),1),t("form",{onSubmit:r[9]||(r[9]=_((...o)=>e.saveMenu&&e.saveMenu(...o),["prevent"])),class:"space-y-4"},[t("div",null,[r[14]||(r[14]=t("label",{class:"text-sm font-medium mb-1 block"},"Название",-1)),M(t("input",{"onUpdate:modelValue":r[1]||(r[1]=o=>e.form.title=o),type:"text",required:"",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.title]])]),t("div",null,[r[15]||(r[15]=t("label",{class:"text-sm font-medium mb-1 block"},"URL или Slug",-1)),M(t("input",{"onUpdate:modelValue":r[2]||(r[2]=o=>e.form.url=o),type:"text",placeholder:"/page или https://example.com",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.url]]),r[16]||(r[16]=t("p",{class:"text-xs text-muted-foreground mt-1"},"Оставьте пустым, если используете slug",-1))]),t("div",null,[r[17]||(r[17]=t("label",{class:"text-sm font-medium mb-1 block"},"Slug",-1)),M(t("input",{"onUpdate:modelValue":r[3]||(r[3]=o=>e.form.slug=o),type:"text",placeholder:"page-slug",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.slug]])]),t("div",null,[r[19]||(r[19]=t("label",{class:"text-sm font-medium mb-1 block"},"Тип меню",-1)),M(t("select",{"onUpdate:modelValue":r[4]||(r[4]=o=>e.form.type=o),required:"",class:"w-full h-10 px-3 border border-border rounded bg-background"},[...r[18]||(r[18]=[t("option",{value:"header"},"Header",-1),t("option",{value:"footer"},"Footer",-1),t("option",{value:"burger"},"Burger Menu",-1)])],512),[[L,e.form.type]])]),t("div",null,[r[21]||(r[21]=t("label",{class:"text-sm font-medium mb-1 block"},"Родительский пункт",-1)),M(t("select",{"onUpdate:modelValue":r[5]||(r[5]=o=>e.form.parent_id=o),class:"w-full h-10 px-3 border border-border rounded bg-background"},[r[20]||(r[20]=t("option",{value:null},"Нет (корневой элемент)",-1)),(u(!0),i(j,null,S(e.availableParents,o=>(u(),i("option",{key:o.id,value:o.id},k(o.title),9,De))),128))],512),[[L,e.form.parent_id]])]),t("div",null,[r[22]||(r[22]=t("label",{class:"text-sm font-medium mb-1 block"},"Порядок",-1)),M(t("input",{"onUpdate:modelValue":r[6]||(r[6]=o=>e.form.order=o),type:"number",min:"0",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.order,void 0,{number:!0}]])]),t("div",Me,[M(t("input",{"onUpdate:modelValue":r[7]||(r[7]=o=>e.form.is_active=o),type:"checkbox",id:"is_active",class:"w-4 h-4"},null,512),[[H,e.form.is_active]]),r[23]||(r[23]=t("label",{for:"is_active",class:"text-sm font-medium cursor-pointer"},"Активен",-1))]),t("div",_e,[t("button",{type:"button",onClick:r[8]||(r[8]=(...o)=>e.closeModal&&e.closeModal(...o)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),t("button",{type:"submit",disabled:e.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},k(e.saving?"Сохранение...":"Сохранить"),9,Ee)])],32)])])])):h("",!0)])}const Be=R(ie,[["render",Ce]]);export{Be as default};
