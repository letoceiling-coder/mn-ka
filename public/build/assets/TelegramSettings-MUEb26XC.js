import{_ as z,c as l,b as t,d as b,t as r,l as g,v as M,f as u,q as v,D as F,F as U,k as A,p as H,h as a,j as G,J as m,o as d,x as J}from"./app-BPqU31tv.js";import{S as x}from"./sweetalert2.esm.all-C0u8rGqG.js";const O={name:"TelegramSettings",setup(){const y=a(!0),e=a(!1),w=a(!1),s=a(!1),c=a(!1),f=a(null),o=a(null),p=a(null),R=a(null),I=a([]),h=a([]),j=a(!1),C=a(""),k=a(null),D=async()=>{y.value=!0,f.value=null;try{const n=await m.get("/api/v1/telegram-settings");if(o.value=n.data.data.settings,p.value=n.data.data.bot_info,o.value.bot_token)try{const i=await m.get("/api/v1/telegram-settings/webhook-info");i.data.success&&(R.value=i.data.data)}catch{}}catch(n){f.value=n.response?.data?.message||"Ошибка загрузки настроек",console.error("Error fetching Telegram settings:",n)}finally{y.value=!1}},_=async()=>{w.value=!0;try{const n=await m.get("/api/v1/telegram-admin-requests",{params:{status:"pending"}});I.value=n.data.data||[]}catch(n){console.error("Error fetching admin requests:",n)}finally{w.value=!1}},T=async()=>{s.value=!0;try{const i=(await m.get("/api/v1/users")).data.data||[];h.value=i.filter(V=>V.telegram_chat_id&&V.roles?.some(N=>["admin","manager"].includes(N.slug)))}catch(n){console.error("Error fetching telegram admins:",n),h.value=[]}finally{s.value=!1}},S=async()=>{e.value=!0,f.value=null;try{const n=await m.put("/api/v1/telegram-settings",o.value);if(n.data.data.bot_info&&(p.value=n.data.data.bot_info),o.value.bot_token)try{const i=await m.get("/api/v1/telegram-settings/webhook-info");i.data.success&&(R.value=i.data.data)}catch{}await x.fire({icon:"success",title:"Успешно!",text:"Настройки успешно сохранены. Webhook зарегистрирован автоматически.",timer:2e3,showConfirmButton:!1})}catch(n){f.value=n.response?.data?.message||"Ошибка сохранения настроек",await x.fire({icon:"error",title:"Ошибка",text:f.value})}finally{e.value=!1}},q=async n=>{c.value=!0;try{const i=await m.post(`/api/v1/telegram-admin-requests/${n}/approve`);await x.fire({icon:"success",title:"Успешно!",text:"Заявка одобрена. Пользователь получил права администратора.",timer:2e3,showConfirmButton:!1}),await _(),await T()}catch(i){await x.fire({icon:"error",title:"Ошибка",text:i.response?.data?.message||"Не удалось одобрить заявку"})}finally{c.value=!1}},B=n=>{k.value=n.id,C.value="",j.value=!0},E=async()=>{if(k.value){c.value=!0;try{const n=await m.post(`/api/v1/telegram-admin-requests/${k.value}/reject`,{reason:C.value});await x.fire({icon:"success",title:"Успешно!",text:"Заявка отклонена.",timer:2e3,showConfirmButton:!1}),j.value=!1,k.value=null,await _()}catch(n){await x.fire({icon:"error",title:"Ошибка",text:n.response?.data?.message||"Не удалось отклонить заявку"})}finally{c.value=!1}}},L=n=>n?new Date(n).toLocaleString("ru-RU"):"";return G(()=>{D(),_(),T()}),{loading:y,saving:e,loadingRequests:w,loadingAdmins:s,processingRequest:c,error:f,settings:o,botInfo:p,webhookInfo:R,adminRequests:I,telegramAdmins:h,showRejectReasonModal:j,rejectReason:C,saveSettings:S,fetchAdminRequests:_,approveRequest:q,showRejectModal:B,rejectRequest:E,formatDate:L}}},W={class:"telegram-settings-page space-y-6"},K={key:0,class:"flex items-center justify-center py-12"},P={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},Q={class:"text-destructive"},X={key:2,class:"space-y-6"},Y={class:"bg-card rounded-lg border border-border p-6 space-y-6"},Z={class:"space-y-4"},$={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ee={key:0,class:"p-4 bg-muted/50 rounded-lg"},te={class:"text-sm text-foreground"},se={key:1,class:"p-4 bg-muted/50 rounded-lg"},oe={class:"text-sm text-foreground"},ne={class:"space-y-4 border-t border-border pt-6"},re={class:"space-y-3"},le={class:"flex items-center gap-3 cursor-pointer"},de={class:"flex items-center gap-3 cursor-pointer"},ae=["disabled"],ie={class:"flex items-center gap-3 cursor-pointer"},ue=["disabled"],ge={class:"space-y-4 border-t border-border pt-6"},be={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},me={class:"space-y-3"},fe={class:"flex items-center gap-3 cursor-pointer"},ce={class:"flex items-center gap-3 cursor-pointer"},xe={class:"flex items-center justify-end gap-4 border-t border-border pt-6"},pe=["disabled"],ve={class:"bg-card rounded-lg border border-border p-6"},ye={class:"flex items-center justify-between mb-4"},we={key:0,class:"text-center py-4 text-muted-foreground"},ke={key:1,class:"text-center py-4 text-muted-foreground"},_e={key:2,class:"space-y-3"},Re={class:"flex items-start justify-between"},he={class:"flex-1"},je={class:"flex items-center gap-2 mb-2"},Ce={class:"font-semibold text-foreground"},Me={class:"text-sm text-muted-foreground"},Ie={key:0,class:"text-sm text-red-600 mt-2"},Te={key:0,class:"flex gap-2"},Ve=["onClick","disabled"],Ue=["onClick","disabled"],Ae={class:"bg-card rounded-lg border border-border p-6"},De={key:0,class:"text-center py-4 text-muted-foreground"},Se={key:1,class:"text-center py-4 text-muted-foreground"},qe={key:2,class:"space-y-2"},Be={class:"flex items-center justify-between"},Ee={class:"font-medium text-foreground"},Le={class:"text-sm text-muted-foreground"},Ne={class:"bg-card rounded-lg border border-border shadow-2xl max-w-md w-full p-6"},ze={class:"space-y-4"},Fe={class:"flex gap-3 justify-end"},He=["disabled"];function Ge(y,e,w,s,c,f){return d(),l("div",W,[e[53]||(e[53]=t("div",null,[t("h1",{class:"text-3xl font-semibold text-foreground"},"Настройки Telegram бота"),t("p",{class:"text-muted-foreground mt-1"}," Настройка интеграции с Telegram для отправки уведомлений и ошибок. После сохранения токена webhook регистрируется автоматически. ")],-1)),s.loading?(d(),l("div",K,[...e[14]||(e[14]=[t("p",{class:"text-muted-foreground"},"Загрузка настроек...",-1)])])):b("",!0),s.error?(d(),l("div",P,[t("p",Q,r(s.error),1)])):b("",!0),!s.loading&&s.settings?(d(),l("div",X,[t("div",Y,[t("div",Z,[e[30]||(e[30]=t("h2",{class:"text-xl font-semibold text-foreground"},"Информация о боте",-1)),t("div",$,[t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-foreground mb-2"}," Токен бота * ",-1)),g(t("input",{type:"password","onUpdate:modelValue":e[0]||(e[0]=o=>s.settings.bot_token=o),placeholder:"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz",class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},null,512),[[M,s.settings.bot_token]]),e[16]||(e[16]=t("p",{class:"text-xs text-muted-foreground mt-1"}," Получите токен у @BotFather в Telegram. После сохранения webhook будет зарегистрирован автоматически. ",-1))]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-foreground mb-2"}," Имя бота ",-1)),g(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=o=>s.settings.bot_name=o),placeholder:"Admin Bot",class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},null,512),[[M,s.settings.bot_name]])])]),s.botInfo?(d(),l("div",ee,[e[23]||(e[23]=t("h3",{class:"font-semibold text-foreground mb-2"},"Информация о боте:",-1)),t("p",te,[e[18]||(e[18]=t("strong",null,"Имя:",-1)),u(" "+r(s.botInfo.first_name)+" "+r(s.botInfo.last_name||""),1),e[19]||(e[19]=t("br",null,null,-1)),e[20]||(e[20]=t("strong",null,"Username:",-1)),u(" @"+r(s.botInfo.username),1),e[21]||(e[21]=t("br",null,null,-1)),e[22]||(e[22]=t("strong",null,"ID:",-1)),u(" "+r(s.botInfo.id),1)])])):b("",!0),s.webhookInfo?(d(),l("div",se,[e[29]||(e[29]=t("h3",{class:"font-semibold text-foreground mb-2"},"Информация о webhook:",-1)),t("p",oe,[e[24]||(e[24]=t("strong",null,"URL:",-1)),u(" "+r(s.webhookInfo.url||"Не установлен"),1),e[25]||(e[25]=t("br",null,null,-1)),e[26]||(e[26]=t("strong",null,"Ожидает обновлений:",-1)),u(" "+r(s.webhookInfo.pending_update_count||0),1),e[27]||(e[27]=t("br",null,null,-1)),e[28]||(e[28]=t("strong",null,"Последняя ошибка:",-1)),u(" "+r(s.webhookInfo.last_error_message||"Нет"),1)])])):b("",!0)]),t("div",ne,[e[34]||(e[34]=t("h2",{class:"text-xl font-semibold text-foreground"},"Общие настройки",-1)),t("div",re,[t("label",le,[g(t("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=o=>s.settings.is_enabled=o),class:"w-4 h-4 rounded border-border"},null,512),[[v,s.settings.is_enabled]]),e[31]||(e[31]=t("span",{class:"text-sm font-medium text-foreground"},"Включить бота",-1))]),t("label",de,[g(t("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=o=>s.settings.send_notifications=o),disabled:!s.settings.is_enabled,class:"w-4 h-4 rounded border-border"},null,8,ae),[[v,s.settings.send_notifications]]),e[32]||(e[32]=t("span",{class:"text-sm font-medium text-foreground"},"Отправлять уведомления",-1))]),t("label",ie,[g(t("input",{type:"checkbox","onUpdate:modelValue":e[4]||(e[4]=o=>s.settings.send_errors=o),disabled:!s.settings.is_enabled,class:"w-4 h-4 rounded border-border"},null,8,ue),[[v,s.settings.send_errors]]),e[33]||(e[33]=t("span",{class:"text-sm font-medium text-foreground"},"Отправлять критические ошибки",-1))])])]),t("div",ge,[e[39]||(e[39]=t("h2",{class:"text-xl font-semibold text-foreground"},"Настройки сообщений",-1)),t("div",be,[t("div",null,[e[36]||(e[36]=t("label",{class:"block text-sm font-medium text-foreground mb-2"}," Режим парсинга ",-1)),g(t("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>s.settings.parse_mode=o),class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},[...e[35]||(e[35]=[t("option",{value:"HTML"},"HTML",-1),t("option",{value:"Markdown"},"Markdown",-1),t("option",{value:"MarkdownV2"},"MarkdownV2",-1)])],512),[[F,s.settings.parse_mode]])])]),t("div",me,[t("label",fe,[g(t("input",{type:"checkbox","onUpdate:modelValue":e[6]||(e[6]=o=>s.settings.disable_notification=o),class:"w-4 h-4 rounded border-border"},null,512),[[v,s.settings.disable_notification]]),e[37]||(e[37]=t("span",{class:"text-sm font-medium text-foreground"},"Отправлять без звука",-1))]),t("label",ce,[g(t("input",{type:"checkbox","onUpdate:modelValue":e[7]||(e[7]=o=>s.settings.disable_web_page_preview=o),class:"w-4 h-4 rounded border-border"},null,512),[[v,s.settings.disable_web_page_preview]]),e[38]||(e[38]=t("span",{class:"text-sm font-medium text-foreground"},"Отключить превью ссылок",-1))])])]),t("div",xe,[t("button",{onClick:e[8]||(e[8]=(...o)=>s.saveSettings&&s.saveSettings(...o)),disabled:s.saving,class:"px-6 py-2 bg-accent text-accent-foreground rounded hover:bg-accent/90 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium"},r(s.saving?"Сохранение...":"Сохранить настройки"),9,pe)])]),t("div",ve,[t("div",ye,[e[40]||(e[40]=t("h2",{class:"text-xl font-semibold text-foreground"},"Заявки на администрирование",-1)),t("button",{onClick:e[9]||(e[9]=(...o)=>s.fetchAdminRequests&&s.fetchAdminRequests(...o)),class:"px-4 py-2 text-sm border border-border rounded hover:bg-accent/10"}," Обновить ")]),s.loadingRequests?(d(),l("div",we," Загрузка заявок... ")):s.adminRequests.length===0?(d(),l("div",ke," Нет заявок на рассмотрении ")):(d(),l("div",_e,[(d(!0),l(U,null,A(s.adminRequests,o=>(d(),l("div",{key:o.id,class:"p-4 border border-border rounded-lg"},[t("div",Re,[t("div",he,[t("div",je,[t("h3",Ce,r(o.telegram_first_name)+" "+r(o.telegram_last_name||""),1),t("span",{class:J(["px-2 py-1 text-xs rounded",o.status==="pending"?"bg-yellow-500/20 text-yellow-600":o.status==="approved"?"bg-green-500/20 text-green-600":"bg-red-500/20 text-red-600"])},r(o.status==="pending"?"На рассмотрении":o.status==="approved"?"Одобрена":"Отклонена"),3)]),t("p",Me,[e[41]||(e[41]=t("strong",null,"Username:",-1)),u(" @"+r(o.telegram_username||"не указан"),1),e[42]||(e[42]=t("br",null,null,-1)),e[43]||(e[43]=t("strong",null,"Telegram ID:",-1)),u(" "+r(o.telegram_user_id),1),e[44]||(e[44]=t("br",null,null,-1)),e[45]||(e[45]=t("strong",null,"Chat ID:",-1)),u(" "+r(o.chat_id),1),e[46]||(e[46]=t("br",null,null,-1)),e[47]||(e[47]=t("strong",null,"Дата:",-1)),u(" "+r(s.formatDate(o.created_at)),1)]),o.rejection_reason?(d(),l("p",Ie,[e[48]||(e[48]=t("strong",null,"Причина отклонения:",-1)),u(" "+r(o.rejection_reason),1)])):b("",!0)]),o.status==="pending"?(d(),l("div",Te,[t("button",{onClick:p=>s.approveRequest(o.id),disabled:s.processingRequest,class:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 text-sm"}," Одобрить ",8,Ve),t("button",{onClick:p=>s.showRejectModal(o),disabled:s.processingRequest,class:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50 text-sm"}," Отклонить ",8,Ue)])):b("",!0)])]))),128))]))]),t("div",Ae,[e[50]||(e[50]=t("h2",{class:"text-xl font-semibold text-foreground mb-4"},"Администраторы с Telegram",-1)),s.loadingAdmins?(d(),l("div",De," Загрузка... ")):s.telegramAdmins.length===0?(d(),l("div",Se," Нет администраторов с подключенным Telegram ")):(d(),l("div",qe,[(d(!0),l(U,null,A(s.telegramAdmins,o=>(d(),l("div",{key:o.id,class:"p-3 border border-border rounded-lg"},[t("div",Be,[t("div",null,[t("p",Ee,r(o.name),1),t("p",Le,[u(" Email: "+r(o.email),1),e[49]||(e[49]=t("br",null,null,-1)),u(" Telegram Chat ID: "+r(o.telegram_chat_id),1)])])])]))),128))]))])])):b("",!0),s.showRejectReasonModal?(d(),l("div",{key:3,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4",onClick:e[13]||(e[13]=H(o=>s.showRejectReasonModal=!1,["self"]))},[t("div",Ne,[e[52]||(e[52]=t("h3",{class:"text-lg font-semibold text-foreground mb-4"},"Отклонить заявку",-1)),t("div",ze,[t("div",null,[e[51]||(e[51]=t("label",{class:"block text-sm font-medium text-foreground mb-2"}," Причина отклонения (необязательно) ",-1)),g(t("textarea",{"onUpdate:modelValue":e[10]||(e[10]=o=>s.rejectReason=o),rows:"3",class:"w-full px-3 py-2 border border-border rounded bg-background text-sm",placeholder:"Укажите причину отклонения заявки..."},null,512),[[M,s.rejectReason]])]),t("div",Fe,[t("button",{onClick:e[11]||(e[11]=o=>s.showRejectReasonModal=!1),class:"px-4 py-2 border border-border rounded hover:bg-accent/10 text-sm"}," Отмена "),t("button",{onClick:e[12]||(e[12]=(...o)=>s.rejectRequest&&s.rejectRequest(...o)),disabled:s.processingRequest,class:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50 text-sm"}," Отклонить ",8,He)])])])])):b("",!0)])}const We=z(O,[["render",Ge]]);export{We as default};
