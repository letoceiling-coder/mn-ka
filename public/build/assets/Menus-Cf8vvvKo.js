import{_ as N,h as f,c as i,F as B,k as S,p as _,r as R,o as u,A as P,b as r,d as h,t as k,a as q,l as M,v as T,D as L,G as H,i as z,j as G}from"./app-wAW8xXV9.js";import{a as A,c as F,b as J,d as K}from"./api-V9GPpd21.js";import{S as C}from"./sweetalert2.esm.all-C0u8rGqG.js";const Q={name:"MenuTree",props:{items:{type:Array,required:!0}},emits:["edit","delete","refresh","order-updated"],setup(g,{emit:t}){const c=f(null),e=f(null),m=f(null);return{draggedItem:c,draggedIndex:e,dragOverIndex:m,onDragStart:(a,p,x)=>{c.value=p,e.value=x,a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("text/html",a.target),a.target.style.opacity="0.5"},onDragEnd:a=>{a.target.style.opacity="1",c.value=null,e.value=null,m.value=null},onDragOver:a=>{a.preventDefault(),a.dataTransfer.dropEffect="move"},onItemDragOver:(a,p)=>{a.preventDefault(),e.value!==null&&e.value!==p&&(m.value=p)},onItemDragEnter:a=>{e.value!==null&&e.value!==a&&(m.value=a)},onItemDragLeave:()=>{},onDrop:a=>{if(a.preventDefault(),!c.value||e.value===null)return;const p=m.value!==null?m.value:e.value;if(e.value===p){m.value=null;return}const x=[...g.items],[U]=x.splice(e.value,1);x.splice(p,0,U);const j=x.map((y,n)=>({id:y.id,order:n,parent_id:y.parent_id||null}));t("order-updated",{items:j,newOrder:x.map(y=>y.id),newItems:x.map((y,n)=>({...y,order:n}))}),m.value=null}}}},W=["onDragstart","onDragover","onDragenter"],X={class:"flex items-center justify-between p-4 border-b border-border hover:bg-muted/5 cursor-move"},Y={class:"flex items-center gap-3 flex-1"},Z={class:"flex items-center gap-2 flex-1"},$={class:"text-sm font-medium text-foreground"},ee={class:"text-xs px-2 py-1 rounded bg-muted text-muted-foreground"},te={key:0,class:"text-xs text-muted-foreground"},re={key:1,class:"text-xs px-2 py-1 rounded bg-red-500/10 text-red-500"},oe={class:"flex items-center gap-2"},ne=["onClick"],le=["onClick"],se={key:0,class:"ml-6 border-l border-border"};function ae(g,t,c,e,m,E){const D=R("MenuTree",!0);return u(),i("div",{class:"menu-tree",onDragover:t[6]||(t[6]=_((...o)=>e.onDragOver&&e.onDragOver(...o),["prevent"])),onDrop:t[7]||(t[7]=_((...o)=>e.onDrop&&e.onDrop(...o),["prevent"]))},[(u(!0),i(B,null,S(c.items,(o,l)=>(u(),i("div",{key:o.id,class:P(["menu-item",{dragging:e.draggedItem?.id===o.id,"drag-over":e.dragOverIndex===l}]),draggable:!0,onDragstart:s=>e.onDragStart(s,o,l),onDragend:t[4]||(t[4]=(...s)=>e.onDragEnd&&e.onDragEnd(...s)),onDragover:_(s=>e.onItemDragOver(s,l),["prevent"]),onDragenter:_(s=>e.onItemDragEnter(l),["prevent"]),onDragleave:t[5]||(t[5]=(...s)=>e.onItemDragLeave&&e.onItemDragLeave(...s))},[r("div",X,[r("div",Y,[t[8]||(t[8]=r("svg",{class:"w-5 h-5 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 8h16M4 16h16"})],-1)),r("div",Z,[r("span",$,k(o.title),1),r("span",ee,k(o.type),1),o.url||o.slug?(u(),i("span",te,k(o.url||(o.slug?"/"+o.slug:"")),1)):h("",!0),o.is_active?h("",!0):(u(),i("span",re," Неактивен "))])]),r("div",oe,[r("button",{onClick:_(s=>g.$emit("edit",o),["stop"]),class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"}," Редактировать ",8,ne),r("button",{onClick:_(s=>g.$emit("delete",o),["stop"]),class:"px-3 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors"}," Удалить ",8,le)])]),o.children&&o.children.length>0?(u(),i("div",se,[q(D,{items:o.children,onEdit:t[0]||(t[0]=s=>g.$emit("edit",s)),onDelete:t[1]||(t[1]=s=>g.$emit("delete",s)),onRefresh:t[2]||(t[2]=s=>g.$emit("refresh")),onOrderUpdated:t[3]||(t[3]=s=>g.$emit("order-updated",s))},null,8,["items"])])):h("",!0)],42,W))),128))],32)}const de=N(Q,[["render",ae],["__scopeId","data-v-20f8c6fd"]]),ie={name:"Menus",components:{MenuTree:de},setup(){const g=f(!1),t=f(!1),c=f(null),e=f([]),m=f([]),E=f("header"),D=f(!1),o=f(!1),l=f({id:null,title:"",slug:"",url:"",type:"header",parent_id:null,order:0,is_active:!0}),s=[{value:"header",label:"Header Меню"},{value:"footer",label:"Footer Меню"}],V=z(()=>m.value.filter(n=>n.type===l.value.type&&n.id!==l.value.id&&(!n.parent_id||n.parent_id===null))),I=async()=>{g.value=!0,c.value=null;try{const n=await A("/menus",{type:E.value});if(!n.ok)throw new Error("Ошибка загрузки меню");const b=await n.json();e.value=b.data||[];const d=await A("/menus");if(d.ok){const v=await d.json();m.value=a(v.data||[])}}catch(n){c.value=n.message||"Ошибка загрузки меню"}finally{g.value=!1}},a=n=>{let b=[];return n.forEach(d=>{b.push(d),d.children&&d.children.length>0&&(b=b.concat(a(d.children)))}),b},p=n=>{l.value={id:n.id,title:n.title,slug:n.slug||"",url:n.url||"",type:n.type,parent_id:n.parent_id,order:n.order,is_active:n.is_active},o.value=!0},x=async n=>{if((await C.fire({title:"Удалить пункт меню?",text:`Вы уверены, что хотите удалить "${n.title}"?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Да, удалить",cancelButtonText:"Отмена"})).isConfirmed)try{const d=await K(`/menus/${n.id}`);if(!d.ok){const v=await d.json();throw new Error(v.message||"Ошибка удаления")}await C.fire("Удалено!","Пункт меню успешно удален.","success"),await I()}catch(d){await C.fire("Ошибка!",d.message||"Не удалось удалить пункт меню.","error")}},U=async()=>{t.value=!0,c.value=null;try{const n=l.value.id?`/menus/${l.value.id}`:"/menus",d=await(l.value.id?J:F)(n,{title:l.value.title,slug:l.value.slug||null,url:l.value.url||null,type:l.value.type,parent_id:l.value.parent_id||null,order:l.value.order||0,is_active:l.value.is_active});if(!d.ok){const v=await d.json();throw new Error(v.message||"Ошибка сохранения")}await C.fire("Успешно!","Пункт меню успешно сохранен.","success"),y(),await I()}catch(n){c.value=n.message||"Ошибка сохранения",await C.fire("Ошибка!",c.value,"error")}finally{t.value=!1}},j=n=>{const b=JSON.parse(JSON.stringify(e.value));if(n.newOrder&&Array.isArray(n.newOrder)){const v=new Map;e.value.forEach(w=>{v.set(w.id,{...w})}),e.value=n.newOrder.map(w=>{const O=v.get(w);return O?{...O}:null}).filter(Boolean),e.value.forEach((w,O)=>{w.order=O})}const d=n.items||[];F("/menus/update-order",{items:d}).then(v=>{if(!v.ok)return v.json().then(w=>{throw new Error(w.message||"Ошибка обновления порядка")})}).catch(v=>{console.error("Ошибка обновления порядка на сервере:",v),e.value=b,C.fire({title:"Ошибка",text:v.message||"Не удалось сохранить порядок меню. Изменения отменены.",icon:"error",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3})})},y=()=>{D.value=!1,o.value=!1,l.value={id:null,title:"",slug:"",url:"",type:E.value,parent_id:null,order:0,is_active:!0}};return G(async()=>{await I()}),{loading:g,saving:t,error:c,menus:e,selectedType:E,menuTypes:s,showCreateModal:D,showEditModal:o,form:l,availableParents:V,fetchMenus:I,editMenu:p,deleteMenu:x,saveMenu:U,closeModal:y,handleOrderUpdate:j}}},ue={class:"menus-page space-y-6"},ce={class:"flex items-center justify-between"},ve={class:"flex gap-2"},ge=["onClick"],me={key:0,class:"flex items-center justify-center py-12"},fe={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},be={class:"text-destructive"},pe={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},xe={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},ye={key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm overflow-y-auto p-4"},we={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md my-auto"},he={class:"p-6"},ke={class:"text-lg font-semibold mb-4"},De=["value"],Me={class:"flex items-center gap-2"},_e={class:"flex gap-2 pt-4"},Ee=["disabled"];function Ce(g,t,c,e,m,E){const D=R("MenuTree");return u(),i("div",ue,[r("div",ce,[t[11]||(t[11]=r("div",null,[r("h1",{class:"text-3xl font-semibold text-foreground"},"Меню"),r("p",{class:"text-muted-foreground mt-1"},"Управление меню сайта (Header, Footer)")],-1)),r("button",{onClick:t[0]||(t[0]=o=>e.showCreateModal=!0),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...t[10]||(t[10]=[r("span",null,"+",-1),r("span",null,"Создать пункт меню",-1)])])]),r("div",ve,[(u(!0),i(B,null,S(e.menuTypes,o=>(u(),i("button",{key:o.value,onClick:l=>{e.selectedType=o.value,e.fetchMenus()},class:P(["px-4 py-2 rounded-lg transition-colors",e.selectedType===o.value?"bg-accent/20 text-accent border border-accent/40":"bg-card border border-border text-foreground hover:bg-muted/10"])},k(o.label),11,ge))),128))]),e.loading?(u(),i("div",me,[...t[12]||(t[12]=[r("p",{class:"text-muted-foreground"},"Загрузка меню...",-1)])])):h("",!0),e.error?(u(),i("div",fe,[r("p",be,k(e.error),1)])):h("",!0),!e.loading&&e.menus.length>0?(u(),i("div",pe,[q(D,{items:e.menus,onEdit:e.editMenu,onDelete:e.deleteMenu,onRefresh:e.fetchMenus,onOrderUpdated:e.handleOrderUpdate},null,8,["items","onEdit","onDelete","onRefresh","onOrderUpdated"])])):h("",!0),!e.loading&&e.menus.length===0?(u(),i("div",xe,[...t[13]||(t[13]=[r("p",{class:"text-muted-foreground"},"Меню не найдены. Создайте первый пункт меню.",-1)])])):h("",!0),e.showCreateModal||e.showEditModal?(u(),i("div",ye,[r("div",we,[r("div",he,[r("h3",ke,k(e.showEditModal?"Редактировать пункт меню":"Создать пункт меню"),1),r("form",{onSubmit:t[9]||(t[9]=_((...o)=>e.saveMenu&&e.saveMenu(...o),["prevent"])),class:"space-y-4"},[r("div",null,[t[14]||(t[14]=r("label",{class:"text-sm font-medium mb-1 block"},"Название",-1)),M(r("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>e.form.title=o),type:"text",required:"",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.title]])]),r("div",null,[t[15]||(t[15]=r("label",{class:"text-sm font-medium mb-1 block"},"URL или Slug",-1)),M(r("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>e.form.url=o),type:"text",placeholder:"/page или https://example.com",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.url]]),t[16]||(t[16]=r("p",{class:"text-xs text-muted-foreground mt-1"},"Оставьте пустым, если используете slug",-1))]),r("div",null,[t[17]||(t[17]=r("label",{class:"text-sm font-medium mb-1 block"},"Slug",-1)),M(r("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>e.form.slug=o),type:"text",placeholder:"page-slug",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.slug]])]),r("div",null,[t[19]||(t[19]=r("label",{class:"text-sm font-medium mb-1 block"},"Тип меню",-1)),M(r("select",{"onUpdate:modelValue":t[4]||(t[4]=o=>e.form.type=o),required:"",class:"w-full h-10 px-3 border border-border rounded bg-background"},[...t[18]||(t[18]=[r("option",{value:"header"},"Header",-1),r("option",{value:"footer"},"Footer",-1),r("option",{value:"burger"},"Burger Menu",-1)])],512),[[L,e.form.type]])]),r("div",null,[t[21]||(t[21]=r("label",{class:"text-sm font-medium mb-1 block"},"Родительский пункт",-1)),M(r("select",{"onUpdate:modelValue":t[5]||(t[5]=o=>e.form.parent_id=o),class:"w-full h-10 px-3 border border-border rounded bg-background"},[t[20]||(t[20]=r("option",{value:null},"Нет (корневой элемент)",-1)),(u(!0),i(B,null,S(e.availableParents,o=>(u(),i("option",{key:o.id,value:o.id},k(o.title),9,De))),128))],512),[[L,e.form.parent_id]])]),r("div",null,[t[22]||(t[22]=r("label",{class:"text-sm font-medium mb-1 block"},"Порядок",-1)),M(r("input",{"onUpdate:modelValue":t[6]||(t[6]=o=>e.form.order=o),type:"number",min:"0",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[T,e.form.order,void 0,{number:!0}]])]),r("div",Me,[M(r("input",{"onUpdate:modelValue":t[7]||(t[7]=o=>e.form.is_active=o),type:"checkbox",id:"is_active",class:"w-4 h-4"},null,512),[[H,e.form.is_active]]),t[23]||(t[23]=r("label",{for:"is_active",class:"text-sm font-medium cursor-pointer"},"Активен",-1))]),r("div",_e,[r("button",{type:"button",onClick:t[8]||(t[8]=(...o)=>e.closeModal&&e.closeModal(...o)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),r("button",{type:"submit",disabled:e.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},k(e.saving?"Сохранение...":"Сохранить"),9,Ee)])],32)])])])):h("",!0)])}const Ue=N(ie,[["render",Ce]]);export{Ue as default};
