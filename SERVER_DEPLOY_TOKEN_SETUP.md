# Настройка DEPLOY_TOKEN для работы деплоя

## ✅ Маршрут работает!

Запрос доходит до Laravel. Теперь нужно настроить токен.

## Настройка токена на сервере

### Шаг 1: Проверьте токен на локальной машине

На локальной машине проверьте токен в `.env`:

```bash
# На локальной машине
grep DEPLOY_TOKEN .env
```

Должна быть строка вида:
```
DEPLOY_TOKEN=ваш-секретный-токен-минимум-32-символа
```

### Шаг 2: Установите тот же токен на сервере

На сервере откройте `.env` и добавьте/обновите:

```bash
cd /home/d/dsc23ytp/stroy/public_html

# Откройте .env в редакторе
nano .env
# или
vi .env
```

Добавьте строку (используйте ТОТ ЖЕ токен, что на локальной машине):

```env
DEPLOY_TOKEN=ваш-секретный-токен-из-локального-env
```

Сохраните файл.

### Шаг 3: Очистите кеш конфигурации

После изменения `.env` нужно очистить кеш:

```bash
cd /home/d/dsc23ytp/stroy/public_html
PHP82="/usr/local/bin/php8.2"

# Очистите кеш конфигурации
$PHP82 artisan config:clear
$PHP82 artisan config:cache
```

### Шаг 4: Проверьте токен

```bash
# Проверьте, что токен сохранен
grep DEPLOY_TOKEN .env

# Попробуйте снова (должен вернуть другой ответ, не "Неверный токен")
curl -X POST https://post-ads.ru/api/deploy \
  -H "Content-Type: application/json" \
  -H "X-Deploy-Token: ваш-токен"
```

---

## Генерация нового токена (если нужно)

Если токена нет, сгенерируйте его:

```bash
# На локальной или на сервере
openssl rand -hex 32
# или
php -r "echo bin2hex(random_bytes(32));"
```

Скопируйте полученный токен и добавьте его в `.env` на обеих машинах (локальной и сервере).

---

## Тест деплоя с локальной машины

После настройки токена попробуйте деплой:

```bash
# На локальной машине
php artisan deploy --insecure
```

Система должна успешно подключиться и выполнить деплой!

---

## Проверка после настройки

```bash
# На сервере - проверьте токен
cd /home/d/dsc23ytp/stroy/public_html
grep DEPLOY_TOKEN .env

# Очистите кеш
/usr/local/bin/php8.2 artisan config:clear
/usr/local/bin/php8.2 artisan config:cache

# Проверьте через curl (замените YOUR_TOKEN)
curl -X POST https://post-ads.ru/api/deploy \
  -H "Content-Type: application/json" \
  -H "X-Deploy-Token: YOUR_TOKEN"
```

Должен вернуться ответ с информацией о деплое, а не ошибка "Неверный токен".

---

## Важно

⚠️ **Токен должен быть ОДИНАКОВЫМ на локальной машине и на сервере!**

Токен используется для безопасности - только тот, у кого есть правильный токен, может запускать деплой.

