# Руководство по использованию системы импорта/экспорта

## Обзор

Система импорта/экспорта позволяет администраторам экспортировать и импортировать данные из разделов административной панели в виде ZIP архивов с CSV файлами и изображениями.

## Реализованные функции

### ✅ Backend

1. **ChaptersExport.php** и **ChaptersImport.php** - экспорт/импорт разделов
2. **CasesExport.php** и **CasesImport.php** - экспорт/импорт случаев с галереями изображений
3. **DecisionsExport.php** и **DecisionsImport.php** - полный экспорт/импорт всех разделов
4. **DecisionController.php** - новый контроллер для полного экспорта/импорта
5. Обновлены **ChapterController** и **CaseController** с методами export/import
6. Добавлены роуты в **routes/api.php**
7. Обновлен **MediaImportService** с поддержкой создания папок по названиям разделов

### ✅ Frontend

1. **ImportExportButtons.vue** - компонент с кнопками и выпадающими меню
2. Интеграция в **Header.vue** с условным отображением в разделе decisions
3. Модальное окно с детальными результатами импорта
4. Отображение ошибок с номерами строк и описанием

## Использование

### Экспорт данных

1. Перейдите в раздел `/admin/decisions`
2. В header появятся кнопки "Экспорт" и "Импорт"
3. Нажмите на кнопку "Экспорт"
4. Выберите нужный вариант:
   - **Экспорт всех разделов** - экспортирует все данные в один ZIP
   - **Экспорт разделов** - только chapters
   - **Экспорт продуктов** - только products
   - **Экспорт услуг** - только services
   - **Экспорт случаев** - только cases
5. Файл автоматически загрузится в браузер

### Импорт данных

1. Подготовьте ZIP архив с правильной структурой (см. ниже)
2. Нажмите на кнопку "Импорт" в header
3. Выберите тип импорта:
   - **Импорт всех разделов** - импортирует все разделы из одного ZIP
   - **Импорт разделов** - только chapters
   - **Импорт продуктов** - только products
   - **Импорт услуг** - только services
   - **Импорт случаев** - только cases
4. Выберите файл на вашем компьютере
5. Дождитесь завершения импорта
6. Просмотрите результаты в модальном окне

## Структура ZIP архива

### Для отдельных разделов

#### Chapters (Разделы)
```
chapters_YYYY-MM-DD_HHMMSS.zip
└── chapters.csv
```

**Формат chapters.csv:**
```csv
ID;Название;Порядок;Активен
1;Раздел 1;1;1
2;Раздел 2;2;1
```

#### Products (Продукты)
```
products_YYYY-MM-DD_HHMMSS.zip
├── products.csv
└── images/
    ├── products/
    │   └── product_image.jpg
    └── icons/
        └── product_icon.svg
```

**Формат products.csv:**
```csv
ID;Название;Slug;Описание;Раздел ID;Название раздела;SEO Title;SEO Description;SEO Keywords;ID изображения;Путь изображения;URL изображения;ID иконки;Путь иконки;URL иконки;Услуги (ID через запятую);Порядок;Активен
```

#### Services (Услуги)
```
services_YYYY-MM-DD_HHMMSS.zip
├── services.csv
└── images/
    ├── services/
    │   └── service_image.jpg
    └── icons/
        └── service_icon.svg
```

**Формат services.csv:**
```csv
ID;Название;Slug;Описание;HTML контент;Раздел ID;Название раздела;SEO Title;SEO Description;SEO Keywords;ID изображения;Путь изображения;URL изображения;ID иконки;Путь иконки;URL иконки;Продукты (ID через запятую);Опции (ID через запятую);Деревья опций (ID через запятую);Экземпляры (ID через запятую);Порядок;Активен
```

#### Cases (Случаи)
```
cases_YYYY-MM-DD_HHMMSS.zip
├── cases.csv
└── images/
    ├── cases/
    │   └── case_main.jpg
    ├── icons/
    │   └── case_icon.svg
    └── gallery/
        ├── case_gallery_1.jpg
        └── case_gallery_2.jpg
```

**Формат cases.csv:**
```csv
ID;Название;Slug;Описание;HTML;Раздел ID;Название раздела;SEO Title;SEO Description;SEO Keywords;ID изображения;Путь изображения;URL изображения;ID иконки;Путь иконки;URL иконки;Галерея (ID через запятую);Пути галереи (через запятую);Услуги (ID через запятую);Продукты (ID через запятую);Порядок;Активен
```

### Для полного экспорта

```
decisions_full_YYYY-MM-DD_HHMMSS.zip
├── chapters.csv
├── products.csv
├── services.csv
├── cases.csv
└── images/
    ├── products/
    ├── services/
    ├── cases/
    ├── icons/
    └── gallery/
```

## API Endpoints

### Экспорт

- `GET /api/v1/admin/chapters/export` - экспорт разделов
- `GET /api/v1/admin/products/export` - экспорт продуктов
- `GET /api/v1/admin/services/export` - экспорт услуг
- `GET /api/v1/admin/cases/export` - экспорт случаев
- `GET /api/v1/admin/decisions/export` - полный экспорт всех разделов

### Импорт

- `POST /api/v1/admin/chapters/import` - импорт разделов
- `POST /api/v1/admin/products/import` - импорт продуктов
- `POST /api/v1/admin/services/import` - импорт услуг
- `POST /api/v1/admin/cases/import` - импорт случаев
- `POST /api/v1/admin/decisions/import` - полный импорт всех разделов

**Параметры импорта:**
- `file` (required) - ZIP или CSV файл для импорта
- Максимальный размер: 100MB для отдельных разделов, 200MB для полного импорта

**Пример ответа импорта:**
```json
{
  "success": true,
  "message": "Импорт завершен. Успешно: 15, Пропущено: 2",
  "success_count": 15,
  "skip_count": 2,
  "errors": [
    {
      "row": 5,
      "section": "Products",
      "errors": [
        "Поле name обязательно для заполнения",
        "Не удалось загрузить изображение: images/products/missing.jpg"
      ],
      "data": {
        "name": "",
        "slug": "test-product"
      }
    }
  ]
}
```

## Обработка ошибок

### Уведомления об ошибках

Система отображает детальные уведомления об ошибках:

1. **Номер строки** - точный номер строки в CSV файле, где произошла ошибка
2. **Секция** - название раздела (для полного импорта)
3. **Описание ошибок** - список всех ошибок для данной строки
4. **Данные** - данные, которые пытались импортировать

### Типы ошибок

1. **Валидация**:
   - Обязательные поля не заполнены
   - Неверный формат данных
   - Несуществующие связи (chapter_id, service_id и т.д.)

2. **Ошибки изображений**:
   - Файл не найден в архиве
   - Неподдерживаемый формат изображения
   - Ошибка при загрузке/копировании файла

3. **Системные ошибки**:
   - Ошибка распаковки ZIP архива
   - Недостаточно прав доступа
   - Ошибка базы данных

## Логирование

Все операции импорта/экспорта логируются в `storage/logs/laravel.log`:

```
[2026-01-15 12:34:56] local.INFO: Chapters export started {"count":5,"temp_dir":"..."}
[2026-01-15 12:34:57] local.INFO: Chapters export completed {"file":"chapters_2026-01-15_123456.zip","size":1048576}
[2026-01-15 12:35:10] local.INFO: Products import started {"file":"products.zip","size":5242880}
[2026-01-15 12:35:15] local.INFO: Products import completed {"success_count":12,"skip_count":1,"errors_count":1}
```

## Регистрация медиа файлов

При импорте изображения автоматически регистрируются в библиотеке медиа:

- **Разделы**: изображения сохраняются в общую папку
- **Продукты**: создается/используется папка "Products"
- **Услуги**: создается/используется папка "Services"
- **Случаи**: создается/используется папка "Cases"

Это позволяет легко организовать и найти импортированные файлы в медиа-библиотеке.

## Рекомендации

### Перед импортом

1. **Сделайте резервную копию** базы данных
2. **Проверьте структуру** ZIP архива
3. **Убедитесь**, что все обязательные поля заполнены в CSV
4. **Проверьте существование** связанных записей (chapter_id, service_id и т.д.)

### При создании CSV вручную

1. Используйте **точку с запятой** (;) как разделитель
2. Сохраняйте файл в кодировке **UTF-8 с BOM** для корректного отображения кириллицы
3. **Пути к изображениям** должны быть относительными от корня архива: `images/products/image.jpg`
4. **ID через запятую** без пробелов: `1,2,3`, а не `1, 2, 3`
5. **Булевы значения**: используйте `1` для true, `0` для false

### Оптимизация

1. Для больших объемов данных разбивайте импорт на несколько файлов
2. При полном экспорте/импорте учитывайте порядок:
   - Сначала chapters
   - Затем products и services
   - В конце cases (так как они зависят от products и services)

## Устранение проблем

### Ошибка "Не удалось распаковать ZIP архив"

- Проверьте, что файл действительно является ZIP архивом
- Убедитесь, что архив не поврежден
- Проверьте права доступа к директории `storage/app/temp/`

### Ошибка "CSV файл не найден"

- Убедитесь, что CSV файл находится в корне архива
- Имя файла должно соответствовать типу: `chapters.csv`, `products.csv` и т.д.

### Ошибка "Не удалось загрузить изображение"

- Проверьте путь к изображению в CSV файле
- Убедитесь, что изображение находится в архиве по указанному пути
- Проверьте формат изображения (допустимы: jpg, jpeg, png, gif, webp, svg)

### Медленный импорт

- Для больших файлов увеличьте лимиты в `.env`:
  ```
  UPLOAD_MAX_FILESIZE=200M
  MAX_FILE_UPLOADS=500
  ```
- Увеличьте `memory_limit` и `max_execution_time` в `php.ini`

## Заключение

Система импорта/экспорта полностью реализована согласно плану и готова к использованию. Все компоненты протестированы и документированы.

Если у вас возникли вопросы или проблемы, проверьте логи в `storage/logs/laravel.log` или обратитесь к разработчикам.

