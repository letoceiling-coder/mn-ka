# Варианты решения для импорта продуктов/услуг с загрузкой изображений

## Проблема
При импорте CSV/Excel файлов продуктов или услуг нужно также загружать изображения. CSV/Excel файлы не могут содержать бинарные данные изображений напрямую, поэтому требуется специальный подход.

---

## Вариант 1: ZIP архив с CSV + папка изображений

### Суть решения
- Пользователь создает ZIP архив, содержащий:
  - CSV файл с данными
  - Папку с изображениями (например, `images/`)
- В CSV указываются относительные пути к изображениям из архива

### Структура архива:
```
import.zip
├── products.csv
└── images/
    ├── product1.jpg
    ├── product2.png
    └── icons/
        ├── icon1.svg
        └── icon2.png
```

### CSV формат:
```csv
ID;Название;Slug;Image Path;Icon Path;...
1;Продукт 1;/product-1;images/product1.jpg;images/icons/icon1.svg;...
```

### Плюсы:
- ✅ Все данные в одном файле
- ✅ Простота для пользователя
- ✅ Можно импортировать много изображений за раз
- ✅ Сохраняется структура папок

### Минусы:
- ❌ Требуется распаковка архива на сервере
- ❌ Дополнительная обработка путей
- ❌ Возможны проблемы с безопасностью (пути)

### Технические детали:
- Загрузка ZIP через FormData
- Распаковка через `ZipArchive` (PHP)
- Временное хранение распакованных файлов
- Загрузка изображений в Media библиотеку
- Привязка Media ID к продуктам/услугам

---

## Вариант 2: URL изображений в CSV + автоскачивание

### Суть решения
- В CSV указываются URL изображений (локальные пути или внешние ссылки)
- Система автоматически скачивает изображения при импорте

### CSV формат:
```csv
ID;Название;Slug;Image URL;Icon URL;...
1;Продукт 1;/product-1;https://example.com/images/product1.jpg;/uploads/icons/icon1.svg;...
```

### Плюсы:
- ✅ Простота CSV формата
- ✅ Можно использовать существующие изображения
- ✅ Поддержка внешних URL
- ✅ Легко редактировать вручную

### Минусы:
- ❌ Нужен доступ к изображениям (локальным или по сети)
- ❌ Риск недоступности внешних URL
- ❌ Дольше импорт (скачивание каждого изображения)
- ❌ Нет контроля над источниками

### Технические детали:
- Валидация URL перед скачиванием
- Скачивание через `file_get_contents()` или `curl`
- Проверка типа файла (MIME)
- Временное сохранение, затем загрузка в Media
- Обработка ошибок скачивания

---

## Вариант 3: Base64 кодирование изображений в CSV

### Суть решения
- Изображения кодируются в Base64 и вставляются прямо в CSV
- При импорте декодируются и сохраняются

### CSV формат (упрощенный):
```csv
ID;Название;Image Base64;Icon Base64
1;Продукт 1;data:image/jpeg;base64,/9j/4AAQSkZJRg...;data:image/svg+xml;base64,PHN2Zy...
```

### Плюсы:
- ✅ Все данные в одном файле
- ✅ Не нужны внешние файлы
- ✅ Простота для простых случаев

### Минусы:
- ❌ Огромный размер CSV файла
- ❌ Сложность редактирования в Excel
- ❌ Проблемы с кодировкой
- ❌ Медленная обработка
- ❌ Ограничения размера файла

---

## Вариант 4: Многофайловая загрузка (CSV + отдельные изображения)

### Суть решения
- Пользователь загружает CSV + отдельно выбирает изображения через интерфейс
- В CSV указываются имена файлов
- Система сопоставляет имена файлов с загруженными изображениями

### Интерфейс:
```
1. Выберите CSV файл
2. Загрузите изображения (drag & drop или выбор файлов)
3. Система автоматически сопоставит по именам
```

### CSV формат:
```csv
ID;Название;Image Filename;Icon Filename
1;Продукт 1;product1.jpg;icon1.svg
```

### Плюсы:
- ✅ Разделение данных и файлов
- ✅ Удобный интерфейс загрузки
- ✅ Видно что именно загружается
- ✅ Можно использовать Media библиотеку для выбора

### Минусы:
- ❌ Два шага вместо одного
- ❌ Нужно правильно назвать файлы
- ❌ Сложнее для пользователя

---

## Вариант 5: Excel с встроенными изображениями + Export шаблон

### Суть решения
- Использование Excel формата (.xlsx), который поддерживает встроенные изображения
- Создание шаблона Excel с примерами
- Изображения хранятся прямо в Excel файле

### Плюсы:
- ✅ Всё в одном файле
- ✅ Визуальный контроль в Excel
- ✅ Стандартный формат

### Минусы:
- ❌ Сложная обработка (библиотека для Excel)
- ❌ Большой размер файлов
- ❌ Сложнее автоматизация

### Технические детали:
- Использование библиотеки типа `PhpSpreadsheet` или `Laravel Excel`
- Извлечение изображений из Excel
- Сохранение в Media библиотеку

---

## Вариант 6: Импорт через API с предварительной загрузкой изображений

### Суть решения
1. Сначала загружаются все изображения в Media библиотеку (bulk upload)
2. Получаются ID загруженных файлов
3. В CSV указываются ID или имена загруженных файлов
4. Импорт CSV с привязкой по ID/имени

### Плюсы:
- ✅ Использование существующей Media библиотеки
- ✅ Контроль за загруженными файлами
- ✅ Можно предварительно подготовить файлы
- ✅ Гибкость (можно заменить изображения)

### Минусы:
- ❌ Два этапа (сначала загрузка, потом импорт)
- ❌ Нужно отслеживать соответствие

---

## Вариант 7: Гибридный подход (Рекомендуемый)

### Суть решения
Комбинация вариантов 1 и 6:
- **Основной способ**: ZIP архив с CSV + папка изображений
- **Альтернативный способ**: CSV с URL изображений + автоскачивание
- **Дополнительный способ**: CSV с именами файлов + предварительная загрузка

### CSV формат (с поддержкой всех вариантов):
```csv
ID;Название;Image;Icon;...
1;Продукт 1;images/product1.jpg;images/icons/icon1.svg;...  // Путь в архиве
2;Продукт 2;https://example.com/img.jpg;https://example.com/icon.svg;...  // URL
3;Продукт 3;product3.jpg;icon3.svg;...  // Имя файла (предзагруженного)
4;Продукт 4;123;456;...  // Media ID (существующие в системе)
```

### Логика определения типа:
1. Если это число → Media ID (существующий файл)
2. Если это URL (http/https) → скачать с URL
3. Если это путь с `/` → путь в ZIP архиве
4. Если это просто имя файла → поиск среди предзагруженных

### Плюсы:
- ✅ Максимальная гибкость
- ✅ Поддержка разных сценариев
- ✅ Обратная совместимость
- ✅ Можно использовать любые источники изображений

### Минусы:
- ❌ Более сложная логика обработки
- ❌ Нужна хорошая обработка ошибок

---

## Рекомендации по реализации

### Этап 1: Базовый функционал (ZIP архив)
Начать с варианта 1 (ZIP архив), так как он:
- Наиболее универсальный
- Понятен пользователям
- Все данные в одном файле

### Этап 2: Расширение (URL поддержка)
Добавить вариант 2 для случаев, когда изображения уже есть на сервере или в интернете.

### Этап 3: Гибридный режим
Объединить оба подхода в гибридное решение.

---

## Дополнительные соображения

### Производительность:
- Использовать очереди (queues) для больших импортов
- Пакетная обработка изображений
- Параллельная загрузка (если возможно)

### Безопасность:
- Валидация типов файлов
- Проверка размеров
- Ограничение путей (защита от directory traversal)
- Сканирование на вирусы (для внешних файлов)

### UX:
- Прогресс-бар для импорта
- Предпросмотр перед импортом
- Возможность отменить импорт
- Детальный лог ошибок

### Шаблоны:
- Предоставить шаблоны CSV/Excel
- Примеры структуры ZIP архива
- Документация по форматам

---

## Технический стек для реализации

### Для ZIP:
- `ZipArchive` (встроен в PHP)

### Для Excel с изображениями:
- `PhpSpreadsheet` или `maatwebsite/excel` (если будет доступна для Laravel 12)

### Для работы с файлами:
- Laravel Storage
- Очереди (Queue) для фоновой обработки
- Валидация через Laravel Request классы

---

## Пример структуры ZIP импорта

```
import-products-2025-11-29.zip
├── products.csv
├── images/
│   ├── products/
│   │   ├── light-industrial-5.jpg
│   │   ├── heavy-industrial-10.jpg
│   │   └── warehouse.jpg
│   └── icons/
│       ├── industry.svg
│       ├── warehouse.svg
│       └── storage.svg
```

### CSV файл:
```csv
ID;Название;Slug;Image Path;Icon Path;Chapter ID;Order;Active
;Light Industrial до 5 га;/light-industrial-5;images/products/light-industrial-5.jpg;images/icons/industry.svg;1;0;1
;Heavy Industrial 10 га;/heavy-industrial-10;images/products/heavy-industrial-10.jpg;images/icons/industry.svg;1;1;1
```

---

## Вывод

**Рекомендуемый подход**: Начать с **Варианта 1 (ZIP архив)** как основного, затем добавить поддержку **Варианта 2 (URL)** для гибкости. В итоге получить **Вариант 7 (Гибридный)** с поддержкой всех форматов.

Это даст максимальную гибкость при разумной сложности реализации.

